<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pylon Screenwriting</title>
  <style>
    /* ===== BASE LAYOUT ===== */
    body {
      display: flex;
      margin: 0;
      height: 100vh;
      font-family: "Courier Prime", Courier, monospace;
      overflow: hidden;
      background: #f5f5f5;
      position: relative; /* For floating buttons */
      transition: background 0.3s, color 0.3s;
    }
    /* Dark mode */
    body.dark-mode {
      background: #1e1e1e;
      color: #ccc;
    }
    
    /* ===== PREVIEW (LEFT - 66%) ===== */
    #preview {
      width: 66%;
      padding: 2.5cm 2.5cm;
      overflow-y: auto;
      background: #fff;
      box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
      line-height: 1.2;
      font-size: 12pt;
      white-space: pre-wrap;
      box-sizing: border-box;
      transition: background 0.3s, color 0.3s;
    }
    body.dark-mode #preview {
      background: #333;
      color: #eee;
      box-shadow: inset 0 0 5px rgba(255,255,255,0.1);
    }

    /* ===== INPUT (RIGHT - 34%) ===== */
    #inputContainer {
      width: 34%;
      display: flex;
      flex-direction: row;
      border-left: 1px solid #e0e0e0;
      box-sizing: border-box;
      background: #fafafa;
      transition: background 0.3s, color 0.3s;
    }
    body.dark-mode #inputContainer {
      background: #444;
    }
    /* Line numbers panel */
    #lineNumbers {
      width: 40px;
      padding: 1.5cm 0.5cm 1.5cm 0.5cm;
      background: #eaeaea;
      text-align: right;
      color: #666;
      font-size: 12pt;
      line-height: 1.2;
      box-sizing: border-box;
      user-select: none;
      overflow: hidden;
    }
    body.dark-mode #lineNumbers {
      background: #555;
      color: #bbb;
    }
    /* Textarea */
    #fountainInput {
      flex: 1;
      padding: 1.5cm;
      border: none;
      font-family: "Courier Prime", Courier, monospace;
      font-size: 12pt;
      line-height: 1.2;
      resize: none;
      outline: none;
      background: inherit;
      color: inherit;
      box-sizing: border-box;
      overflow-y: auto; /* Vertical scroll only */
      overflow-x: hidden; /* Prevent horizontal scroll */
    }

    /* ===== BUTTONS ===== */
    .btn {
      position: fixed;
      padding: 10px 15px;
      background: #0066cc;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-family: sans-serif;
      font-size: 14px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      transition: background 0.3s;
      z-index: 1000;
    }
    .btn:hover {
      background: #0055aa;
    }
    #exportBtn {
      bottom: 20px;
      right: 20px;
    }
    #importBtn {
      bottom: 20px;
      right: 150px;
    }
    #darkModeToggle {
      bottom: 20px;
      left: 20px;
    }
    /* Hide the default file input */
    #importFile {
      display: none;
    }

    /* ===== STRICT SCREENPLAY FORMATTING & SYNTAX HIGHLIGHTING ===== */
    .scene-heading {
      font-weight: bold;
      text-transform: uppercase;
      margin: 1.2em 0 0.6em 0;
      padding: 0;
      width: 100%;
      color: #0055aa;
    }
    .action {
      margin: 0 0 0.8em 0;
      width: 100%;
      padding-right: 2cm;
      color: #000;
    }
    .character {
      margin: 1em 0 0 4.2cm;
      font-weight: bold;
      width: 7cm;
      color: #333;
    }
    .dialogue {
      margin: 0 0 0 2.8cm;
      width: 9cm;
      padding-right: 2cm;
      color: #111;
    }
    .parenthetical {
      margin: 0 0 0 3.5cm;
      width: 6cm;
      font-style: italic;
      padding-right: 2cm;
      color: #666;
    }
    .transition {
      margin: 1em 0 0 0;
      text-align: right;
      padding-right: 2cm;
      font-weight: bold;
      text-transform: uppercase;
      color: #aa5500;
    }
    /* Blank line helper */
    .blank-line {
      margin: 0;
      min-height: 1.2em;
    }
    
    body.dark-mode .scene-heading { color: #88bfff; }
    body.dark-mode .action { color: #fff; }
    body.dark-mode .character { color: #ddd; }
    body.dark-mode .dialogue { color: #eee; }
    body.dark-mode .parenthetical { color: #bbb; }
    body.dark-mode .transition { color: #ffcc99; }
    
    /* Import font */
    @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap');
  </style>
</head>
<body>
  <!-- Preview -->
  <div id="preview">Type in the editor to see a properly formatted screenplay preview...</div>
  
  <!-- Input container with line numbers & textarea -->
  <div id="inputContainer">
    <div id="lineNumbers">1</div>
    <textarea id="fountainInput" placeholder="INT. LOCATION - DAY

Character action...

CHARACTER
(parenthetical)
Dialogue...

CUT TO:">INT. COFFEE SHOP - DAY

John sits alone, the steam from his coffee swirling in the morning light.

JOHN
(sighing)
Another day, another script to format.

He rubs his eyes, then continues typing.

CUT TO:

EXT. PARK - SUNSET

A lone dog runs across the grass.

JOHN (V.O.)
Sometimes I wonder if the dog has it easier.
    </textarea>
  </div>

  <!-- Buttons -->
  <button id="exportBtn" class="btn">Export .fountain</button>
  <button id="importBtn" class="btn">Import .fountain</button>
  <button id="darkModeToggle" class="btn">Toggle Dark Mode</button>
  <input type="file" id="importFile" accept=".fountain,.txt" />

  <script>
    const input = document.getElementById('fountainInput');
    const preview = document.getElementById('preview');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const importFile = document.getElementById('importFile');
    const darkModeToggle = document.getElementById('darkModeToggle');
    const lineNumbers = document.getElementById('lineNumbers');

    // Parse Fountain text into formatted HTML blocks.
    function parseFountain(text) {
      const lines = text.split('\n');
      let html = '';
      let inDialogue = false;
      
      for (let i = 0; i < lines.length; i++) {
        // Use the raw line (do not trim) so blank lines stay empty.
        const rawLine = lines[i];
        const line = rawLine.trim();
        const prevLine = i > 0 ? lines[i-1].trim() : '';
        
        if (rawLine === "") {
          // Use a div with fixed line height for blank lines.
          html += `<div class="blank-line">&nbsp;</div>`;
          inDialogue = false;
          continue;
        }

        // Scene Headings (starting with INT., EXT., EST., I/E.)
        if (/^(INT|EXT|EST|I\/E)[\.:]? .+/i.test(line)) {
          html += `<div class="scene-heading">${line.toUpperCase()}</div>`;
          inDialogue = false;
        } 
        // Transitions (e.g., CUT TO:, FADE IN:, FADE OUT:, DISSOLVE TO:)
        else if (/^(FADE (IN|OUT|TO):?|CUT TO:?|DISSOLVE TO:?)$/i.test(line)) {
          html += `<div class="transition">${line.toUpperCase()}</div>`;
          inDialogue = false;
        }
        // Character (all uppercase, may include numbers and punctuation, and preceded by a blank line or at the very start)
        else if (/^[A-Z0-9 .()'â€™\-]+$/.test(line) && (i === 0 || prevLine === '')) {
          html += `<div class="character">${line}</div>`;
          inDialogue = true;
        }
        // Parenthetical (within dialogue)
        else if (/^\(.+\)$/.test(line) && inDialogue) {
          html += `<div class="parenthetical">${line}</div>`;
        }
        // Dialogue (if in dialogue block)
        else if (inDialogue) {
          html += `<div class="dialogue">${line}</div>`;
        }
        // Otherwise, treat it as Action.
        else {
          html += `<div class="action">${line}</div>`;
          inDialogue = false;
        }
      }
      
      return html || '<div class="action">/* Script preview will appear here */</div>';
    }

    // Update the preview pane with parsed Fountain content.
    function updatePreview() {
      preview.innerHTML = parseFountain(input.value);
    }

    // Update line numbers based on the current number of lines in the textarea.
    function updateLineNumbers() {
      const lines = input.value.split('\n').length;
      let numbersHTML = '';
      for (let i = 1; i <= lines; i++) {
        numbersHTML += i + '<br>';
      }
      lineNumbers.innerHTML = numbersHTML;
    }

    // Sync scroll positions between textarea, preview, and line numbers.
    function syncScroll() {
      const ratio = input.scrollTop / (input.scrollHeight - input.clientHeight);
      preview.scrollTop = ratio * (preview.scrollHeight - preview.clientHeight);
      lineNumbers.scrollTop = input.scrollTop;
    }
    
    // Export the Fountain script as a .fountain file.
    function exportScript() {
      const content = input.value;
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `screenplay_${new Date().toISOString().slice(0,10)}.fountain`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    
    // Import a Fountain script from a file.
    function importScript(file) {
      const reader = new FileReader();
      reader.onload = (evt) => {
        input.value = evt.target.result;
        updatePreview();
        updateLineNumbers();
      };
      reader.readAsText(file);
    }
    
    // Toggle dark mode by toggling a class on the body.
    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
    }
    
    // Event listeners.
    input.addEventListener('input', () => {
      updatePreview();
      updateLineNumbers();
    });
    input.addEventListener('paste', () => {
      setTimeout(() => { // delay to allow paste to complete.
        updatePreview();
        updateLineNumbers();
      }, 0);
    });
    input.addEventListener('scroll', syncScroll);
    
    exportBtn.addEventListener('click', exportScript);
    importBtn.addEventListener('click', () => { importFile.click(); });
    importFile.addEventListener('change', (e) => {
      if (e.target.files && e.target.files[0]) {
        importScript(e.target.files[0]);
      }
    });
    darkModeToggle.addEventListener('click', toggleDarkMode);
    
    // Initial render.
    updatePreview();
    updateLineNumbers();
  </script>
</body>
</html>
