<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Professional Fountain Editor</title>
  <style>
    /* ===== BASE LAYOUT ===== */
    body {
      display: flex;
      margin: 0;
      height: 100vh;
      font-family: "Courier Prime", Courier, monospace;
      overflow: hidden;
      background: #f5f5f5;
      position: relative; /* For floating buttons */
      transition: background 0.3s, color 0.3s;
    }
    body.dark-mode {
      background: #1e1e1e;
      color: #ccc;
    }

    /* ===== PREVIEW (Left Pane - 66%) ===== */
    #preview {
      width: 66%;
      padding: 2.5cm 2.5cm;
      overflow-y: auto;
      background: white;
      box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
      line-height: 1.4;
      font-size: 12pt;
      white-space: pre-wrap;
      box-sizing: border-box;
      transition: background 0.3s, color 0.3s;
    }
    body.dark-mode #preview {
      background: #333;
      color: #eee;
      box-shadow: inset 0 0 5px rgba(255,255,255,0.1);
    }

    /* ===== INPUT (Right Pane - 34%) ===== */
    #inputContainer {
      width: 34%;
      display: flex;
      flex-direction: row;
      border-left: 1px solid #e0e0e0;
      box-sizing: border-box;
      background: #fafafa;
      transition: background 0.3s, color 0.3s;
    }
    body.dark-mode #inputContainer {
      background: #444;
    }
    /* Line numbers panel */
    #lineNumbers {
      width: 40px;
      padding: 1.5cm 0.5cm 1.5cm 0.5cm;
      background: #eaeaea;
      text-align: right;
      color: #666;
      font-size: 12pt;
      line-height: 1.2;
      box-sizing: border-box;
      user-select: none;
      overflow: hidden;
    }
    body.dark-mode #lineNumbers {
      background: #555;
      color: #bbb;
    }
    /* Textarea (changed font to Arial, sans-serif) */
    #fountainInput {
      flex: 1;
      padding: 1.5cm;
      border: none;
      font-family: Arial, sans-serif;
      font-size: 12pt;
      line-height: 1.2;
      resize: none;
      outline: none;
      background: inherit;
      color: inherit;
      box-sizing: border-box;
      overflow-y: auto; /* Vertical scroll only */
      overflow-x: hidden; /* Prevent horizontal scroll */
    }

    /* ===== BUTTONS ===== */
    .btn {
      position: fixed;
      padding: 10px 15px;
      background: #0066cc;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-family: sans-serif;
      font-size: 14px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      transition: background 0.3s;
      z-index: 1000;
    }
    .btn:hover {
      background: #0055aa;
    }
    #exportBtn { bottom: 20px; right: 20px; }
    #importBtn { bottom: 20px; right: 150px; }
    #darkModeToggle { bottom: 20px; left: 20px; }
    /* Hide default file input */
    #importFile { display: none; }

    /* ===== FOUNTAIN ELEMENT STYLING ===== */
    /* Title Page */
    .title-page { text-align: center; margin-top: 4em; font-size: 14pt; font-weight: bold; }
    /* Section Headers (# ...) */
    .section { font-weight: bold; margin-top: 1em; text-decoration: underline; }
    /* Synopsis (= ...) */
    .synopsis { font-style: italic; color: #666; margin-top: 0.5em; }
    /* Notes (// note) */
    .note { color: #999; font-style: italic; margin: 0.5em 0; padding-left: 1em; border-left: 2px solid #ccc; }
    /* Centered text (> ... <) */
    .centered { text-align: center; margin: 1em 0; font-size: 12pt; font-style: italic; }
    /* Page break (===) */
    .page-break { border-top: 2px dashed #ccc; margin: 1em 0; }

    /* Fountain body elements */
    .scene-heading { font-weight: bold; text-transform: uppercase; margin: 1.2em 0 0.5em; color: #0055aa; }
    .action { margin: 0 0 1em; }
    .character { margin: 1em 0 0 4cm; font-weight: bold; }
    .parenthetical { font-style: italic; margin-left: 3.5cm; }
    .dialogue { margin: 0 0 0 2.8cm; width: 9cm; }
    .transition { text-align: right; font-weight: bold; text-transform: uppercase; margin-top: 1em; color: #aa5500; }
    .lyrics { margin-left: 2.5cm; font-style: italic; }
    
    /* Inline formatting helpers */
    .bold { font-weight: bold; }
    .italic { font-style: italic; }
    .bolditalic { font-weight: bold; font-style: italic; }
  </style>
</head>
<body>
  <!-- Preview Pane -->
  <div id="preview">Type in the editor to see your screenplay preview...</div>

  <!-- Input Pane with Line Numbers and Textarea -->
  <div id="inputContainer">
    <div id="lineNumbers">1</div>
    <textarea id="fountainInput" placeholder="TITLE: My Screenplay
CREDIT: Written By
AUTHOR: John Doe

# Act One

INT. COFFEE SHOP - DAY

John sits alone, the steam from his coffee swirling in the morning light.

JOHN
(sighing)
Another day, another script to format.

>Centered Text Example<

[[This is a note about the action.]]

CUT TO:

EXT. PARK - SUNSET

A lone dog runs across the grass.

JOHN (V.O.)
Sometimes I wonder if the dog has it easier.
===

FADE OUT">TITLE: My Screenplay
CREDIT: Written By
AUTHOR: John Doe

# Act One

INT. COFFEE SHOP - DAY

John sits alone, the steam from his coffee swirling in the morning light.

JOHN
(sighing)
Another day, another script to format.

>Centered Text Example<

[[This is a note about the action.]]

CUT TO:

EXT. PARK - SUNSET

A lone dog runs across the grass.

JOHN (V.O.)
Sometimes I wonder if the dog has it easier.
===
FADE OUT
    </textarea>
  </div>

  <!-- Buttons and hidden file input -->
  <button id="exportBtn" class="btn">Export .fountain</button>
  <button id="importBtn" class="btn">Import .fountain</button>
  <button id="darkModeToggle" class="btn">Toggle Dark Mode</button>
  <input type="file" id="importFile" accept=".fountain,.txt">

  <script>
    const input = document.getElementById('fountainInput');
    const preview = document.getElementById('preview');
    const lineNumbers = document.getElementById('lineNumbers');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const importFile = document.getElementById('importFile');
    const darkModeToggle = document.getElementById('darkModeToggle');

    // Helper: escape HTML entities
    function escapeHTML(str) {
      return str.replace(/[&<>"']/g, m => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'}[m]));
    }

    // Apply inline styling for **bold**, _italic_ and ***bold italic***
    function stylize(line) {
      return line
        .replace(/\*\*\*(.+?)\*\*\*/g, '<span class="bolditalic">$1</span>')
        .replace(/\*\*(.+?)\*\*/g, '<span class="bold">$1</span>')
        .replace(/_(.+?)_/g, '<span class="italic">$1</span>');
    }

    // Comprehensive Fountain parser (same as your last working version)
    function parseFountain(text) {
      const lines = text.split('\n');
      let html = '';
      let inDialog = false;
      let inBoneyard = false;
      for (let i = 0; i < lines.length; i++) {
        let raw = lines[i];
        let line = stylize(raw);
        let trimmed = line.trim();
        // Boneyard: ignore lines within /* ... */
        if (trimmed.startsWith('/*')) { inBoneyard = true; continue; }
        if (trimmed.endsWith('*/')) { inBoneyard = false; continue; }
        if (inBoneyard) continue;
        // Blank line
        if (trimmed === "") {
          html += '<br>';
          inDialog = false;
          continue;
        }
        // Title Page
        if (/^(title|credit|author|draft date|date|contact):/i.test(trimmed)) {
          html += `<div class="title-page">${escapeHTML(trimmed)}</div>`;
          continue;
        }
        // Section Headers (# ...)
        if (/^#+\s+/.test(trimmed)) {
          html += `<div class="section">${escapeHTML(trimmed.replace(/^#+\s+/, ''))}</div>`;
          inDialog = false;
          continue;
        }
        // Synopsis (= ...)
        if (/^=\s+/.test(trimmed)) {
          html += `<div class="synopsis">${escapeHTML(trimmed.slice(1).trim())}</div>`;
          inDialog = false;
          continue;
        }
        // Notes ([[ ... ]])
        if (/^\[\[(.+?)\]\]$/.test(trimmed)) {
          let match = trimmed.match(/^\[\[(.+?)\]\]$/);
          html += `<div class="note">${escapeHTML(match[1])}</div>`;
          inDialog = false;
          continue;
        }
        // Centered text (> ... <)
        if (/^>.*<$/.test(trimmed)) {
          html += `<div class="centered">${escapeHTML(trimmed.slice(1, -1).trim())}</div>`;
          inDialog = false;
          continue;
        }
        // Page Break (===)
        if (/^={3,}$/.test(trimmed)) {
          html += `<div class="page-break"></div>`;
          inDialog = false;
          continue;
        }
        // Scene Heading (INT./EXT./EST./I/E.)
        if (/^(INT\.|EXT\.|EST\.|I\/E\.)/.test(trimmed)) {
          html += `<div class="scene-heading">${escapeHTML(trimmed)}</div>`;
          inDialog = false;
          continue;
        }
        // Transition (e.g., CUT TO:, FADE IN:, FADE OUT:, etc.)
        if (/^(FADE (TO BLACK|IN|OUT)|CUT TO:|DISSOLVE TO:|SMASH CUT TO:|WIPE TO:|TO:)$/.test(trimmed)) {
          html += `<div class="transition">${escapeHTML(trimmed)}</div>`;
          inDialog = false;
          continue;
        }
        // Character (all uppercase, optionally with (V.O.) or (O.S.), preceded by a blank line)
        if (/^[A-Z0-9 ()'.\-]+$/.test(trimmed) && (i === 0 || lines[i-1].trim() === "")) {
          html += `<div class="character">${escapeHTML(trimmed)}</div>`;
          inDialog = true;
          continue;
        }
        // Parenthetical (within dialogue)
        if (/^\(.*\)$/.test(trimmed) && inDialog) {
          html += `<div class="parenthetical">${escapeHTML(trimmed)}</div>`;
          continue;
        }
        // Lyrics (lines starting with "~")
        if (/^~/.test(trimmed)) {
          html += `<div class="lyrics">${escapeHTML(trimmed.slice(1).trim())}</div>`;
          continue;
        }
        // Dialogue (if in a dialogue block)
        if (inDialog) {
          html += `<div class="dialogue">${escapeHTML(trimmed)}</div>`;
          continue;
        }
        // Fallback Action
        html += `<div class="action">${escapeHTML(trimmed)}</div>`;
        inDialog = false;
      }
      return html || '<div class="action">/* Script preview will appear here */</div>';
    }

    // Update preview pane
    function updatePreview() {
      preview.innerHTML = parseFountain(input.value);
    }

    // Update line numbers
    function updateLineNumbers() {
      const totalLines = input.value.split('\n').length;
      let numbersHTML = '';
      for (let i = 1; i <= totalLines; i++) {
        numbersHTML += i + '<br>';
      }
      lineNumbers.innerHTML = numbersHTML;
    }

    // Sync scroll positions
    function syncScroll() {
      const ratio = input.scrollTop / (input.scrollHeight - input.clientHeight);
      preview.scrollTop = ratio * (preview.scrollHeight - preview.clientHeight);
      lineNumbers.scrollTop = input.scrollTop;
    }

    // Export Fountain script as a .fountain file
    function exportScript() {
      const blob = new Blob([input.value], {type: 'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `screenplay_${new Date().toISOString().slice(0,10)}.fountain`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Import Fountain script from file
    function importScript(file) {
      const reader = new FileReader();
      reader.onload = (evt) => {
        input.value = evt.target.result;
        updatePreview();
        updateLineNumbers();
      };
      reader.readAsText(file);
    }

    // Toggle dark mode
    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
    }

    // Event listeners
    input.addEventListener('input', () => {
      updatePreview();
      updateLineNumbers();
    });
    input.addEventListener('paste', () => {
      setTimeout(() => {
        updatePreview();
        updateLineNumbers();
      }, 0);
    });
    input.addEventListener('scroll', syncScroll);
    exportBtn.addEventListener('click', exportScript);
    importBtn.addEventListener('click', () => { importFile.click(); });
    importFile.addEventListener('change', (e) => {
      if (e.target.files && e.target.files[0])
        importScript(e.target.files[0]);
    });
    darkModeToggle.addEventListener('click', toggleDarkMode);

    // Initial rendering
    updatePreview();
    updateLineNumbers();
  </script>
</body>
</html>
